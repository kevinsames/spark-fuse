name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Free up disk space for runner
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          docker system prune --all --force
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Pin Spark runtime for tests
        run: |
          python - <<'PY' | tee -a "$GITHUB_ENV"
          import pathlib
          import re
          import pyspark

          spark_home = pathlib.Path(pyspark.__file__).resolve().parent
          jars_dir = spark_home / "jars"
          scala_suffix = None
          spark_version = None

          for jar in sorted(jars_dir.glob("spark-core_*.jar")):
              match = re.search(r"spark-core_(\\d+\\.\\d+)-(\\d+\\.\\d+(?:\\.\\d+)?)\\.jar", jar.name)
              if match:
                  scala_suffix = match.group(1)
                  spark_version = match.group(2)
                  break

          if not scala_suffix:
              scala_suffix = "2.13"
          if not spark_version:
              spark_version = pyspark.__version__

          major_minor = ".".join(spark_version.split(".")[:2])
          delta_map = {"3.3": "2.3.0", "3.4": "2.4.0", "3.5": "3.2.0", "4.0": "4.0.0"}
          delta_version = delta_map.get(major_minor, "4.0.0")

          print(f"SPARK_HOME={spark_home}")
          print(f"SPARK_FUSE_DELTA_SCALA_SUFFIX={scala_suffix}")
          print(f"SPARK_FUSE_DELTA_VERSION={delta_version}")
          PY
      - name: Lint
        run: |
          ruff --version
          ruff check src tests
      - name: Test
        run: |
          pytest --maxfail=1 --disable-warnings -q
